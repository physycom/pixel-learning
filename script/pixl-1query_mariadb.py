#! /usr/bin/env python3

import os
import json
import mysql.connector
from datetime import datetime
import pandas as pd
import argparse
import matplotlib.pyplot as plt

version='1.0.0'
print("[Query-MariaDB] QueryMariadb v" + version)

parser = argparse.ArgumentParser()
parser.add_argument('-c', '--cfg', help='config file', required=True)
args = parser.parse_args()

# load toi
#toi_dict = {'station'    :[140043, 93843],
#            'square'     :[140058, 93850],
#            'stnuova'    :[140053, 93842],
#            'center'     :[140057, 93849],
#            'rialto'     :[140052, 93846],
#            'port'       :[140035, 93845],
#            'academy'    :[140049, 93852],
#            'university' :[140046, 93850]
#            }

#toi_dict = {'0': [140043, 93843], '1': [140044, 93845], '2': [140049, 93846], '3': [140051, 93846], '4': [140052, 93846], '5': [140052, 93850], '6': [140053, 93842], '7': [140053, 93846], '8': [140053, 93847], '9': [140053, 93849], '10': [140053, 93850], '11': [140054, 93845], '12': [140054, 93846], '13': [140054, 93847], '14': [140054, 93849], '15': [140054, 93850], '16': [140054, 93851], '17': [140054, 93852], '18': [140055, 93845], '19': [140055, 93846], '20': [140055, 93847], '21': [140055, 93849], '22': [140055, 93850], '23': [140057, 93846], '24': [140057, 93847], '25': [140057, 93849], '26': [140057, 93850], '27': [140058, 93846], '28': [140058, 93847], '29': [140058, 93849], '30': [140058, 93850], '31': [140059, 93849], '32': [140059, 93850], '33': [140059, 93851]}
toi_dict = {'0': [140043, 93843], '1': [140044, 93843], '2': [140044, 93845], '3': [140044, 93846], '4': [140046, 93843], '5': [140046, 93845], '6': [140046, 93846], '7': [140047, 93839], '8': [140047, 93841], '9': [140047, 93843], '10': [140047, 93846], '11': [140047, 93847], '12': [140047, 93849], '13': [140048, 93841], '14': [140048, 93843], '15': [140048, 93846], '16': [140048, 93847], '17': [140048, 93849], '18': [140049, 93839], '19': [140049, 93841], '20': [140049, 93843], '21': [140049, 93845], '22': [140049, 93846], '23': [140049, 93847], '24': [140051, 93841], '25': [140051, 93843], '26': [140051, 93845], '27': [140051, 93846], '28': [140051, 93847], '29': [140052, 93841], '30': [140052, 93842], '31': [140052, 93845], '32': [140052, 93846], '33': [140052, 93847], '34': [140052, 93849], '35': [140052, 93850], '36': [140053, 93842], '37': [140053, 93843], '38': [140053, 93846], '39': [140053, 93847], '40': [140053, 93849], '41': [140053, 93850], '42': [140053, 93851], '43': [140054, 93842], '44': [140054, 93843], '45': [140054, 93845], '46': [140054, 93846], '47': [140054, 93847], '48': [140054, 93849], '49': [140054, 93850], '50': [140054, 93851], '51': [140054, 93852], '52': [140055, 93842], '53': [140055, 93843], '54': [140055, 93845], '55': [140055, 93846], '56': [140055, 93847], '57': [140055, 93849], '58': [140055, 93850], '59': [140055, 93851], '60': [140057, 93843], '61': [140057, 93845], '62': [140057, 93846], '63': [140057, 93847], '64': [140057, 93849], '65': [140057, 93850], '66': [140057, 93851], '67': [140058, 93843], '68': [140058, 93845], '69': [140058, 93846], '70': [140058, 93847], '71': [140058, 93849], '72': [140058, 93850], '73': [140058, 93851], '74': [140059, 93846], '75': [140059, 93847], '76': [140059, 93849], '77': [140059, 93850], '78': [140059, 93851], '79': [140060, 93855], '80': [140063, 93850]}


# load config
with open(args.cfg) as f:
  config = json.load(f)

query_string = '\n'.join([
  'SELECT TileX, TileY, P, Timestamp FROM cell',
  'WHERE(',
  *['(TileX = {} AND TileY = {}) {}'.format(v[0], v[1], 'OR' if i != len(toi_dict) - 1 else '') for i,v in enumerate(toi_dict.values())],
  ')',
  ';'
])

query = query_string

try:
  db = mysql.connector.connect(
    host=config['host'],
    database=config['database'],
    user=config['user'],
    passwd=config['passwd'],
    port = config['port']
  )
  cursor = db.cursor()

  tquery = datetime.now()
  #cursor.execute(query)
  #result = cursor.fetchall()

  df = pd.read_sql(query, con=db)
  df = df.sort_values(by =['TileX', 'Timestamp'] , ascending=True)
  df.to_csv('toi_P.csv', index=None, sep=';')
  tquery = datetime.now() - tquery
  print('[Query-MariaDB] Query for "{}" took {}'.format(query, tquery))

except Exception as e:
  print('[Query-MariaDB] Error : {}'.format(e))
