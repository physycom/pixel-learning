#! /usr/bin/env python3

import os
import json
import mysql.connector
from datetime import datetime
import pandas as pd
import argparse
import matplotlib.pyplot as plt

version='1.0.0'
print("[Query-MariaDB] QueryMariadb v" + version)

parser = argparse.ArgumentParser()
parser.add_argument('-c', '--cfg', help='config file', required=True)
args = parser.parse_args()

# load toi
#toi_dict = {'station'    :[140043, 93843],
#            'square'     :[140058, 93850],
#            'stnuova'    :[140053, 93842],
#            'center'     :[140057, 93849],
#            'rialto'     :[140052, 93846],
#            'port'       :[140035, 93845],
#            'academy'    :[140049, 93852],
#            'university' :[140046, 93850]
#            }

#toi_dict = {'0': [140043, 93843], '1': [140044, 93845], '2': [140049, 93846], '3': [140051, 93846], '4': [140052, 93846], '5': [140052, 93850], '6': [140053, 93842], '7': [140053, 93846], '8': [140053, 93847], '9': [140053, 93849], '10': [140053, 93850], '11': [140054, 93845], '12': [140054, 93846], '13': [140054, 93847], '14': [140054, 93849], '15': [140054, 93850], '16': [140054, 93851], '17': [140054, 93852], '18': [140055, 93845], '19': [140055, 93846], '20': [140055, 93847], '21': [140055, 93849], '22': [140055, 93850], '23': [140057, 93846], '24': [140057, 93847], '25': [140057, 93849], '26': [140057, 93850], '27': [140058, 93846], '28': [140058, 93847], '29': [140058, 93849], '30': [140058, 93850], '31': [140059, 93849], '32': [140059, 93850], '33': [140059, 93851]}
#toi_dict = {'0': [140043, 93843], '1': [140044, 93843], '2': [140044, 93845], '3': [140044, 93846], '4': [140046, 93843], '5': [140046, 93845], '6': [140046, 93846], '7': [140047, 93839], '8': [140047, 93841], '9': [140047, 93843], '10': [140047, 93846], '11': [140047, 93847], '12': [140047, 93849], '13': [140048, 93841], '14': [140048, 93843], '15': [140048, 93846], '16': [140048, 93847], '17': [140048, 93849], '18': [140049, 93839], '19': [140049, 93841], '20': [140049, 93843], '21': [140049, 93845], '22': [140049, 93846], '23': [140049, 93847], '24': [140051, 93841], '25': [140051, 93843], '26': [140051, 93845], '27': [140051, 93846], '28': [140051, 93847], '29': [140052, 93841], '30': [140052, 93842], '31': [140052, 93845], '32': [140052, 93846], '33': [140052, 93847], '34': [140052, 93849], '35': [140052, 93850], '36': [140053, 93842], '37': [140053, 93843], '38': [140053, 93846], '39': [140053, 93847], '40': [140053, 93849], '41': [140053, 93850], '42': [140053, 93851], '43': [140054, 93842], '44': [140054, 93843], '45': [140054, 93845], '46': [140054, 93846], '47': [140054, 93847], '48': [140054, 93849], '49': [140054, 93850], '50': [140054, 93851], '51': [140054, 93852], '52': [140055, 93842], '53': [140055, 93843], '54': [140055, 93845], '55': [140055, 93846], '56': [140055, 93847], '57': [140055, 93849], '58': [140055, 93850], '59': [140055, 93851], '60': [140057, 93843], '61': [140057, 93845], '62': [140057, 93846], '63': [140057, 93847], '64': [140057, 93849], '65': [140057, 93850], '66': [140057, 93851], '67': [140058, 93843], '68': [140058, 93845], '69': [140058, 93846], '70': [140058, 93847], '71': [140058, 93849], '72': [140058, 93850], '73': [140058, 93851], '74': [140059, 93846], '75': [140059, 93847], '76': [140059, 93849], '77': [140059, 93850], '78': [140059, 93851], '79': [140060, 93855], '80': [140063, 93850]}
toi_dict = {'0': [140041, 93852], '1': [140042, 93852], '2': [140043, 93842], '3': [140043, 93843], '4': [140043, 93845], '5': [140043, 93847], '6': [140044, 93842], '7': [140044, 93843], '8': [140044, 93845], '9': [140044, 93846], '10': [140044, 93847], '11': [140044, 93850], '12': [140044, 93851], '13': [140044, 93852], '14': [140046, 93839], '15': [140046, 93842], '16': [140046, 93843], '17': [140046, 93845], '18': [140046, 93846], '19': [140046, 93847], '20': [140046, 93849], '21': [140046, 93850], '22': [140046, 93851], '23': [140046, 93852], '24': [140047, 93839], '25': [140047, 93841], '26': [140047, 93842], '27': [140047, 93843], '28': [140047, 93845], '29': [140047, 93846], '30': [140047, 93847], '31': [140047, 93849], '32': [140047, 93850], '33': [140047, 93851], '34': [140047, 93852], '35': [140048, 93839], '36': [140048, 93841], '37': [140048, 93842], '38': [140048, 93843], '39': [140048, 93845], '40': [140048, 93846], '41': [140048, 93847], '42': [140048, 93849], '43': [140048, 93854], '44': [140048, 93855], '45': [140049, 93838], '46': [140049, 93839], '47': [140049, 93841], '48': [140049, 93842], '49': [140049, 93843], '50': [140049, 93845], '51': [140049, 93846], '52': [140049, 93847], '53': [140049, 93849], '54': [140049, 93850], '55': [140049, 93851], '56': [140051, 93838], '57': [140051, 93839], '58': [140051, 93841], '59': [140051, 93842], '60': [140051, 93843], '61': [140051, 93845], '62': [140051, 93846], '63': [140051, 93847], '64': [140051, 93849], '65': [140051, 93850], '66': [140052, 93839], '67': [140052, 93841], '68': [140052, 93842], '69': [140052, 93843], '70': [140052, 93845], '71': [140052, 93846], '72': [140052, 93847], '73': [140052, 93849], '74': [140052, 93850], '75': [140052, 93851], '76': [140053, 93841], '77': [140053, 93842], '78': [140053, 93843], '79': [140053, 93845], '80': [140053, 93846], '81': [140053, 93847], '82': [140053, 93849], '83': [140053, 93850], '84': [140053, 93851], '85': [140053, 93852], '86': [140054, 93841], '87': [140054, 93842], '88': [140054, 93843], '89': [140054, 93845], '90': [140054, 93846], '91': [140054, 93847], '92': [140054, 93849], '93': [140054, 93850], '94': [140054, 93851], '95': [140054, 93852], '96': [140055, 93841], '97': [140055, 93842], '98': [140055, 93843], '99': [140055, 93845], '100': [140055, 93846], '101': [140055, 93847], '102': [140055, 93849], '103': [140055, 93850], '104': [140055, 93851], '105': [140055, 93852], '106': [140057, 93841], '107': [140057, 93842], '108': [140057, 93843], '109': [140057, 93845], '110': [140057, 93846], '111': [140057, 93847], '112': [140057, 93849], '113': [140057, 93850], '114': [140057, 93851], '115': [140058, 93842], '116': [140058, 93843], '117': [140058, 93845], '118': [140058, 93846], '119': [140058, 93847], '120': [140058, 93849], '121': [140058, 93850], '122': [140058, 93851], '123': [140059, 93843], '124': [140059, 93845], '125': [140059, 93846], '126': [140059, 93847], '127': [140059, 93849], '128': [140059, 93850], '129': [140059, 93851], '130': [140060, 93846], '131': [140060, 93847], '132': [140060, 93849], '133': [140060, 93850], '134': [140060, 93851], '135': [140060, 93855], '136': [140061, 93847], '137': [140061, 93849], '138': [140061, 93850], '139': [140063, 93849], '140': [140063, 93850], '141': [140064, 93849], '142': [140064, 93850], '143': [140064, 93851], '144': [140065, 93852], '145': [140066, 93852]}

# load config
with open(args.cfg) as f:
  config = json.load(f)

query_string = '\n'.join([
  'SELECT TileX, TileY, P, Timestamp FROM cell',
  'WHERE(',
  *['(TileX = {} AND TileY = {}) {}'.format(v[0], v[1], 'OR' if i != len(toi_dict) - 1 else '') for i,v in enumerate(toi_dict.values())],
  ')',
  ';'
])

query = query_string

try:
  db = mysql.connector.connect(
    host=config['host'],
    database=config['database'],
    user=config['user'],
    passwd=config['passwd'],
    port = config['port']
  )
  cursor = db.cursor()

  tquery = datetime.now()
  #cursor.execute(query)
  #result = cursor.fetchall()

  df = pd.read_sql(query, con=db)
  df = df.sort_values(by =['TileX', 'Timestamp'] , ascending=True)
  df.to_csv('toi_P.csv', index=None, sep=';')
  tquery = datetime.now() - tquery
  print('[Query-MariaDB] Query for "{}" took {}'.format(query, tquery))

except Exception as e:
  print('[Query-MariaDB] Error : {}'.format(e))
